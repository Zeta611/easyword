// Generated by ReScript, PLEASE EDIT WITH CARE

import * as React from "react";
import * as $$Comment from "./Comment.js";
import * as Belt_List from "../node_modules/rescript/lib/es6/belt_List.js";
import * as Reactfire from "reactfire";
import * as Belt_Array from "../node_modules/rescript/lib/es6/belt_Array.js";
import * as DateFormat from "./DateFormat.js";
import * as Belt_Option from "../node_modules/rescript/lib/es6/belt_Option.js";
import * as Caml_module from "../node_modules/rescript/lib/es6/caml_module.js";
import * as Caml_option from "../node_modules/rescript/lib/es6/caml_option.js";
import * as SignInContext from "./SignInContext.js";
import * as JsxRuntime from "react/jsx-runtime";
import * as Caml_js_exceptions from "../node_modules/rescript/lib/es6/caml_js_exceptions.js";
import * as Firestore from "firebase/firestore";
import * as Functions from "firebase/functions";
import * as Outline from "@heroicons/react/24/outline";

var CommentNode = Caml_module.init_mod([
      "CommentRow.res",
      6,
      4
    ], {
      TAG: /* Module */0,
      _0: [[
          /* Function */0,
          "make"
        ]]
    });

var CommentSiblings = Caml_module.init_mod([
      "CommentRow.res",
      174,
      4
    ], {
      TAG: /* Module */0,
      _0: [[
          /* Function */0,
          "make"
        ]]
    });

function CommentRow$CommentNode(props) {
  var match = props.commentNode;
  var comment = match.comment;
  var jargonID = props.jargonID;
  var children = match.children;
  var match$1 = React.useContext(SignInContext.context);
  var user = match$1.user;
  var id = Belt_Option.getExn(Caml_option.undefined_to_opt(comment.id));
  var match$2 = React.useState(function () {
        return {
                displayName: "",
                photoURL: undefined
              };
      });
  var setCommentUser = match$2[1];
  var commentUser = match$2[0];
  var match$3 = React.useState(function () {
        return false;
      });
  var setShowReply = match$3[1];
  var match$4 = React.useState(function () {
        return true;
      });
  var setShowChildren = match$4[1];
  var match$5 = React.useState(function () {
        return "";
      });
  var setContent = match$5[1];
  var content = match$5[0];
  var handleInputChange = function ($$event) {
    var value = $$event.currentTarget.value;
    setContent(function (param) {
          return value;
        });
  };
  var match$6 = React.useState(function () {
        return false;
      });
  var setIsLoading = match$6[1];
  var isLoading = match$6[0];
  var firestore = Reactfire.useFirestore();
  React.useEffect((function () {
          ((async function (param) {
                  var commentUserDocRef = Firestore.doc(firestore, "users/" + comment.user + "");
                  var commentUserDoc = await Firestore.getDoc(commentUserDocRef);
                  if (commentUserDoc.exists()) {
                    return setCommentUser(function (param) {
                                return {
                                        displayName: commentUserDoc.data().displayName,
                                        photoURL: commentUserDoc.data().photoURL
                                      };
                              });
                  } else {
                    return setCommentUser(function (param) {
                                return {
                                        displayName: "탈퇴한 회원",
                                        photoURL: undefined
                                      };
                              });
                  }
                })(undefined));
        }), []);
  var functions = Functions.getFunctions(Reactfire.useFirebaseApp(), "asia-northeast3");
  var addComment = Functions.httpsCallable(functions, "addComment");
  var handleSubmit = function ($$event) {
    $$event.preventDefault();
    if (content.length < 5) {
      window.alert("댓글은 다섯 글자 이상이어야 해요");
    } else if (user == null) {
      window.alert("You need to be signed in to comment!");
    } else {
      setIsLoading(function (param) {
            return true;
          });
      ((async function (param) {
              try {
                var result = await addComment({
                      jargonID: jargonID,
                      content: content,
                      parent: id
                    });
                console.log(result);
                setIsLoading(function (param) {
                      return false;
                    });
                setShowReply(function (param) {
                      return false;
                    });
                return setContent(function (param) {
                            return "";
                          });
              }
              catch (raw_e){
                var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                console.log(e);
                return ;
              }
            })(undefined));
    }
  };
  var photoURL = commentUser.photoURL;
  return JsxRuntime.jsxs(JsxRuntime.Fragment, {
              children: [
                JsxRuntime.jsxs("div", {
                      children: [
                        JsxRuntime.jsxs("div", {
                              children: [
                                JsxRuntime.jsx("span", {
                                      children: photoURL !== undefined ? JsxRuntime.jsx("img", {
                                              className: "mask mask-squircle h-4 w-4",
                                              src: photoURL
                                            }) : JsxRuntime.jsx(Outline.UserCircleIcon, {
                                              className: "h-4 w-4"
                                            })
                                    }),
                                JsxRuntime.jsx("span", {
                                      children: commentUser.displayName,
                                      className: "target:text-teal-600 dark:target:text-teal-300 target:underline decoration-2 text-base-content font-medium",
                                      id: id
                                    }),
                                "·",
                                JsxRuntime.jsx("span", {
                                      children: DateFormat.timeAgo(comment.timestamp.toDate()),
                                      title: comment.timestamp.toDate().toDateString()
                                    })
                              ],
                              className: "flex items-center gap-x-1 text-xs"
                            }),
                        JsxRuntime.jsx("div", {
                              children: comment.content,
                              className: "text-base-content"
                            }),
                        JsxRuntime.jsxs("button", {
                              children: [
                                JsxRuntime.jsx(Outline.ChatBubbleLeftIcon, {
                                      className: "h-5 w-5"
                                    }),
                                "답글"
                              ],
                              className: "btn btn-ghost btn-xs gap-1",
                              onClick: (function (param) {
                                  setShowReply(function (show) {
                                        return !show;
                                      });
                                })
                            })
                      ],
                      className: "flex flex-col gap-y-1 place-items-start text-zinc-500"
                    }),
                match$3[0] ? JsxRuntime.jsx("form", {
                        children: JsxRuntime.jsxs("div", {
                              children: [
                                JsxRuntime.jsx("textarea", {
                                      className: "textarea textarea-bordered textarea-sm rounded-lg place-self-stretch",
                                      id: "comment" + id,
                                      name: "comment" + id,
                                      placeholder: "여러분의 생각은 어떠신가요?",
                                      value: content,
                                      onChange: handleInputChange
                                    }),
                                JsxRuntime.jsx("input", {
                                      className: "btn btn-primary btn-outline btn-xs " + (
                                        isLoading ? "loading" : ""
                                      ) + "",
                                      disabled: isLoading,
                                      type: "submit",
                                      value: "답글"
                                    })
                              ],
                              className: "p-2 gap-1 grid grid-cols-1 place-items-start"
                            }),
                        onSubmit: handleSubmit
                      }) : null,
                match$4[0] ? JsxRuntime.jsxs("div", {
                        children: [
                          JsxRuntime.jsx("button", {
                                className: "flex-none mr-3 w-3 border-r-[2px] border-zinc-300 hover:border-zinc-600",
                                onClick: (function (param) {
                                    setShowChildren(function (show) {
                                          return !show;
                                        });
                                  })
                              }),
                          JsxRuntime.jsx("div", {
                                children: JsxRuntime.jsx(CommentSiblings.make, {
                                      jargonID: jargonID,
                                      siblings: children
                                    }),
                                className: "flex-initial w-full"
                              })
                        ],
                        className: "flex"
                      }) : JsxRuntime.jsxs("div", {
                        children: [
                          JsxRuntime.jsx("div", {
                                className: "flex-none mr-3 w-3 border-r-[2px] border-zinc-300 group-hover:border-zinc-600"
                              }),
                          JsxRuntime.jsx("div", {
                                children: "댓글 " + String($$Comment.countDescendents(children)) + "개 열기",
                                className: "flex-initial w-full text-zinc-500 group-hover:text-zinc-600"
                              })
                        ],
                        className: "group flex cursor-pointer border-zinc-300",
                        onClick: (function (param) {
                            setShowChildren(function (show) {
                                  return !show;
                                });
                          })
                      })
              ]
            });
}

Caml_module.update_mod({
      TAG: /* Module */0,
      _0: [[
          /* Function */0,
          "make"
        ]]
    }, CommentNode, {
      make: CommentRow$CommentNode
    });

function CommentRow$CommentSiblings(props) {
  var jargonID = props.jargonID;
  return Belt_Array.map(Belt_List.toArray(props.siblings), (function (commentNode) {
                return JsxRuntime.jsx("div", {
                            children: JsxRuntime.jsx(CommentNode.make, {
                                  jargonID: jargonID,
                                  commentNode: commentNode
                                }),
                            className: "flex flex-col gap-y-2"
                          }, Belt_Option.getExn(Caml_option.undefined_to_opt(commentNode.comment.id)));
              }));
}

Caml_module.update_mod({
      TAG: /* Module */0,
      _0: [[
          /* Function */0,
          "make"
        ]]
    }, CommentSiblings, {
      make: CommentRow$CommentSiblings
    });

function CommentRow(props) {
  return JsxRuntime.jsx(CommentSiblings.make, {
              jargonID: props.jargonID,
              siblings: props.siblings
            });
}

var make = CommentRow;

export {
  CommentNode ,
  CommentSiblings ,
  make ,
}
/* CommentNode Not a pure module */
